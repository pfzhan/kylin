<!--
* Licensed to the Apache Software Foundation (ASF) under one
* or more contributor license agreements.  See the NOTICE file
* distributed with this work for additional information
* regarding copyright ownership.  The ASF licenses this file
* to you under the Apache License, Version 2.0 (the
* "License"); you may not use this file except in compliance
* with the License.  You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
-->

<div ng-controller="ModelDataModelCtrl">
    <ng-form name="forms.data_model_form">

    <!-- Fact Table Name -->
    <div class="form-group" ng-class="{'required':state.mode=='edit'}">
        <div class="row lineh34">
            <label class="col-xs-12 col-sm-2 control-label concube.detailtrol-label no-padding-right font-color-default align-right">
                <b>{{dataKylin.model.gridDMFactTable}} :</b>
            </label>
            <div class="col-xs-12 col-sm-6" ng-class="{'has-error':forms.data_model_form.table_name.$invalid && (forms.data_model_form.table_name.$dirty||forms.data_model_form.$submitted)}">
              <select chosen ng-model="modelsManager.selectedModel.fact_table" ng-if="state.mode=='edit'"
                      ng-options="table.database+'.'+table.name as table.database+'.'+table.name for table in tableModel.selectProjectTables |orderBy: 'name'| orderBy: 'database' "
                      style="width:100%;"   ng-disabled="cubesLength>0" ng-change="changeFactTable()"
                      name="table_name"
                      ng-required="true"
                      data-placeholder="Fact Table Name"
                      class="chosen-select">
                <option value=""> {{dataKylin.model.editDMSelectFact}} </option>
              </select>

              <small class="help-block" ng-show="forms.data_model_form.innerform.typeahead.$error.required && (forms.data_model_form.innerform.typeahead.$dirty||forms.data_model_form.$submitted)">The fact table is required</small>
              <span ng-if="state.mode=='view'">{{model.fact_table}}</span>
            </div>
        </div>
    </div>

    <!-- Lookup Tables Summary -->
    <div class="dataTables_wrapper form-inline no-footer">
        <div class="row ">
            <div class="col-xs-6" ng-if="state.mode=='edit'">
                <button type="button" class="btn btn-primary" ng-disabled="!modelsManager.selectedModel.fact_table.length"
                        ng-click="openLookupModal();addNewJoin();">
                    <i class="fa fa-plus"></i> {{dataKylin.model.editDMAddLookupTable}}
                </button>
            </div>
            <div class="col-xs-6" ng-if="state.mode!='edit'">
                <b>{{model.lookups.length ? dataKylin.model.gridDMLookupTables : dataKylin.model.gridDMNoLookupTables}}</b>
            </div>
            <div class="col-xs-6">
                <span class="pull-right input-icon input-icon-right nav-search" style="margin-left: 22px;" ng-if="modelsManager.selectedModel.lookups.length">
                    <input type="text" placeholder="Filter ..." class="nav-search-input" ng-model="lookupState.filter"/>
                    <i class="ace-icon fa fa-search nav-search-icon"></i>
                </span>
            </div>
        </div>
        <table ng-if="state.mode=='edit' && modelsManager.selectedModel.lookups.length" class="table table-striped table-hover">
            <thead>
            <tr>
                <th class="col-xs-1">{{dataKylin.model.gridDMID}}</th>
                <th class="col-xs-3">{{dataKylin.model.gridDMTableAlias}}</th>
                <th class="col-xs-3">{{dataKylin.model.gridDMTableName}}</th>
        <!--        <th class="col-xs-1">{{dataKylin.model.gridDMTableKind}}</th>-->
                <th class="col-xs-1">{{dataKylin.model.gridDMJoinType}}</th>
                <th class="col-xs-3">{{dataKylin.model.gridDMJoinCondition}}</th>
                <th ng-if="state.mode=='edit'" class="col-xs-2">{{dataKylin.model.editDMActions}}</th>
            </tr>
            </thead>
            <tbody>
            <tr ng-repeat="lookup in modelsManager.selectedModel.lookups | filter:lookupState.filter track by $index">
                <td>
                    <b>{{$index + 1}}</b>

                </td>
                <!-- Table Name -->
                <td>
                  <i class="fa fa-info-circle" ng-if="selectedTableCubeMap[lookup.alias]" kylinpopover placement="right" ng-title="{{dataKylin.model.gridInUseTip}}" ng-cube="{{selectedTableCubeMap[lookup.alias]}}"  template="modelLookups.html" ></i>
                    <span tooltip="Lookup Table Name">{{lookup.alias}}</span>
                </td>
                <td>
                    <span>{{lookup.table}}</span>
                </td>
<!--              &lt;!&ndash; Table Kind &ndash;&gt;
                <td>
                  <span ng-if="lookup.kind=='FACT'">Limited</span>
                  <span ng-if="lookup.kind=='LOOKUP'">Normal</span>
                </td>-->
                <!-- Join Type -->
                <td>
                    <span>{{lookup.join.type}}</span>
                </td>
                <!-- Join Condition -->
                <td>
                  <ul class="list-unstyled">
                    <li ng-repeat="pk in lookup.join.primary_key track by $index">
                      <code style="white-space: normal">{{lookup.join.foreign_key[$index]}} = {{pk}}</code>
                    </li>
                  </ul>
                </td>
                <td>
                    <!-- edit button -->
                    <button class="btn btn-xs btn-info" ng-disabled="lookupState.editing||selectedTableCubeMap[lookup.alias]"
                            ng-click="editLookup(lookup)" ><i class="fa fa-pencil"></i>
                    </button>
                    <!-- remove button -->
                    <button class="btn btn-xs btn-danger" ng-disabled="lookupState.editing||selectedTableCubeMap[lookup.alias]"
                            ng-click="removeLookup(lookup)" ><i class="fa fa-trash-o"></i>
                    </button>

                </td>
            </tr>
            </tbody>
        </table>

      <table ng-if="state.mode!='edit' && model.lookups.length" class="table table-striped table-hover">
        <thead>
        <tr>
          <th>{{dataKylin.model.gridDMID}}</th>
          <th>{{dataKylin.model.gridDMTableAlias}}</th>
          <th>{{dataKylin.model.gridDMTableName}}</th>
<!--          <th>{{dataKylin.model.gridDMTableKind}}</th>-->
          <th>{{dataKylin.model.gridDMJoinType}}</th>
          <th>{{dataKylin.model.gridDMJoinCondition}}</th>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="lookup in model.lookups | filter:lookupState.filter">
          <td>
            <b>{{$index + 1}}</b>
          </td>
          <!-- Table Name -->
          <td>
            <span tooltip="Lookup Table Alias">{{lookup.alias||lookup.table}}</span>
          </td>
          <td>
            <span>{{lookup.table}}</span>
          </td>
          <!--&lt;!&ndash; Table Kind &ndash;&gt;-->
          <!--<td>-->
            <!--<span ng-if="lookup.kind=='FACT'">Limited</span>-->
            <!--<span ng-if="lookup.kind=='LOOKUP'">Normal</span>-->
          <!--</td>-->
          <!-- Join Type -->
          <td>
            <span>{{lookup.join.type}}</span>
          </td>
          <!-- Join Condition -->
          <td>
            <ul class="list-unstyled">
              <li ng-repeat="pk in lookup.join.primary_key track by $index">
                <code>{{lookup.join.foreign_key[$index]}} = {{pk}}</code>
              </li>
            </ul>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
    </ng-form>

    <!-- Add Join Table Form -->
    <script type="text/ng-template" id="dataModelLookupTable.html">
        <div class="modal-header">
            <h4 class="box-title lighter">Lookup Table</h4>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-xs-8">
                  <ng-form name="lookup_form">
 <!--                   <div class="form-group">
                      <div class="row">
                        <div class="col-xs-12">
                          <select chosen ng-model="newLookup.joinTable" style="width:40%;"
                                  ng-options="table as table for table in aliasName"
                                  name="table_name"  ng-disabled="lookupState.editing"
                                  ng-required="true"
                                  class="chosen-select ">
                            <option value=""> {{dataKylin.model.editDMFromTable}}</option>
                          </select>
                          &lt;!&ndash;Join Type&ndash;&gt;
                          <select class="chosen-select"  chosen ng-model="newLookup.join.type" ng-init="newLookup.join.type='inner'" style="width:10%;"
                                  ng-options="joinType.value as joinType.name for joinType in cubeConfig.joinTypes">
                            <option value=""></option>
                          </select>
                          <label class="control-label  font-color-default " style="width:6%;text-align:center;" ><b>{{dataKylin.model.gridDMJoinType}}</b></label>
                          <select chosen ng-model="newLookup.table" style="width:40%;"
                                  ng-options="table.database+'.'+table.name as table.database+'.'+table.name for table in tableModel.selectProjectTables "
                                  name="table_name"  ng-disabled="lookupState.editing"
                                  ng-required="true"  ng-change="changeJoinTable()"
                                  class="chosen-select ">
                            <option value="">{{dataKylin.model.editDMSelectLookup}} </option>
                          </select>
                        </div>
                      </div>
                    </div>-->

                    <!--Table Name-->
                    <div class="form-group">
                      <div class="row">
                        <label class="control-label col-xs-12 col-sm-3 no-padding-right font-color-default"><b>{{dataKylin.model.editDMLookupTableName}}</b></label>
                        <div ng-class="{'has-error':lookup_form.table_name.$invalid && (lookup_form.table_name.$dirty||forms.model_info_form.$submitted)}">
                          <div class="col-xs-12 col-sm-6">
                            <select chosen ng-model="newLookup.table"
                                    ng-options="table.database+'.'+table.name as table.database+'.'+table.name for table in tableModel.selectProjectTables |orderBy: 'name'| orderBy: 'database' "
                                    style="width:100%;"
                                    name="table_name"
                                    ng-required="true" ng-change="changeJoinTable()"
                                    data-placeholder="Lookup Table Name"
                                    class="chosen-select">
                              <option value=""> {{dataKylin.model.editDMSelectLookup}} </option>
                            </select>

                            <small class="help-block" ng-show="lookup_form.table_name.$invalid && (lookup_form.table_name.$dirty||forms.model_info_form.$submitted)">Table name required</small>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!--Lookup Table Alias-->
                    <div class="form-group">
                      <div class="row">
                        <label class="control-label col-xs-12 col-sm-3 no-padding-right font-color-default" ><b>{{dataKylin.model.gridDMAlias}}</b></label>
                        <div  class="col-xs-12 col-sm-6 ">
                          <input type="text" class="form-control " name="joinTable_alias" placeholder="Input Table Alias" ng-required="true"
                                 ng-model="newLookup.alias" ng-change="changeAlias()"  ng-pattern="/^[A-Z_\d]+$/" >
                          <small class="help-block red" ng-show="lookup_form.joinTable_alias.$error.required && (lookup_form.joinTable_alias.$dirty||lookup_form.joinTable_alias.$submitted)">{{dataKylin.cube.tip_cube_required}}</small>
                          <small class="help-block red" ng-show="!lookup_form.joinTable_alias.$error.required&&lookup_form.joinTable_alias.$invalid && (lookup_form.joinTable_alias.$dirty||lookup_form.$submitted)">{{dataKylin.cube.tip_tableAlias_name_invalid}}</small>
                        </div>
                      </div>
                    </div>

                    <!--Join Type and Columns-->
                    <div class="form-group">
                      <div class="row">
                        <label class="col-sm-3 control-label font-color-default"><b>{{dataKylin.model.gridDMJoinType}}</b></label>
                        <div class="col-sm-6">
                          <select class="form-control"  chosen ng-model="newLookup.join.type" ng-init="newLookup.join.type='inner'"
                                  ng-options="joinType.value as joinType.name for joinType in cubeConfig.joinTypes">
                            <option value=""></option>
                          </select>
                        </div>
                      </div>
                    </div>

<!--                    <div class="form-group">
                      <div class="row">
                        <label class=" col-xs-12 col-sm-3 control-label no-padding-right font-color-default align-right" style="width:55.5%;"><b></b></label>
                        <div class="col-xs-12  col-sm-6 " style="width:42%" >
                          <label>
                            <input type="checkbox" ng-model="newLookup.kind" ng-true-value="FACT" ng-false-value="LOOKUP" >&nbsp;{{dataKylin.model.editDMIsLimited}}
                          </label>
                          <i class="fa fa-info-circle" kylinpopover="" placement="right" title="" template="isLimited.html"></i>
                        </div>
                      </div>
                    </div>-->
                    <div class="form-group">
                      <div class="row">
                        <div class="col-sm-3">
                          <button class="btn btn-xs btn-info" ng-click="addNewJoin();">
                            <i class="fa fa-plus"></i>{{dataKylin.model.editDMLookupNewJoin}}</button>
                        </div>
                      </div>
                    </div>
                    <div class="form-group">
                      <div class="row">
                        <div class="col-xs-12">
                          <div ng-repeat="joinIndex in [] | range: newLookup.join.primary_key.length">
                            <div>
<!--                              <select style="width: 45%" chosen data-placeholder="Join Table Column"
                                      ng-model="newLookup.join.foreign_key[$index]"    ng-change="changeKey($index)"
                                      ng-options="newLookup.joinTable+'.'+columns.name as columns.name for columns in getColumnsByAlias(newLookup.joinTable)" >
                                <option value=""></option>
                              </select>-->
                              <select style="width: 45%" chosen data-placeholder="Fact Table Column"
                                      ng-model="newLookup.join.foreign_key[$index]"    ng-change="changeKey($index)"
                                      ng-options="FactTable.root+'.'+columns.name as columns.name for columns in tableModel.getColumnsByTable(modelsManager.selectedModel.fact_table)" >
                                <option value=""></option>
                              </select>
                              <b>=</b>
                              <select style="width: 45%" chosen data-placeholder="Lookup Table Column"
                                      ng-model="newLookup.join.primary_key[$index]"    ng-change="changeKey($index)"
                                      ng-options="newLookup.alias+'.'+columns.name as columns.name for columns in tableModel.getColumnsByTable(newLookup.table)" >
                                <option value=""></option>
                              </select>
                              <button class="pull-right btn btn-xs btn-danger" style="cursor: pointer" tooltip="{{dataKylin.model.tip_join_delete}}"
                                      ng-click="removeJoin($index);">
                                <i class="fa fa-trash-o pointer"></i>
                              </button>
                            </div>
                            <div class="space-4"></div>
                            <small class="help-block red" ng-show="newLookup.join.isCompatible[$index]==false "><i class="fa fa-exclamation-triangle"></i> <b>{{dataKylin.alert.check_look_up_column}} {{newLookup.join.foreign_key[$index]}}[{{newLookup.join.fk_type[$index]}}] , {{newLookup.join.primary_key[$index]}} [{{newLookup.join.pk_type[$index]}}] </b></small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-form>
                </div>

                <!--Tips-->
                <div class="col-xs-4">
                    <div class="box box-solid">
                        <div class="box-header" ng-bind-html="dataKylin.model.tip_header_lookup_modal">
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-xs-12" ng-bind-html="dataKylin.model.tip_body_lookup_modal">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" ng-click="cancel()">{{dataKylin.model.ac_lookup_cancel}}</button>
          <button class="btn btn-success" ng-disabled="lookup_form.$invalid || !newLookup.join.primary_key.length" ng-click="checkLookupForm()?ok():''">{{dataKylin.model.ac_lookup_ok}}</button>
        </div>
    </script>
</div>
<script type="text/ng-template" id="modelLookups.html">
  <div>
    {{dataKylin.model.gridTableInUse_part_one}}
    {{cube}}
    {{dataKylin.model.gridTableInUse_part_two}}
  </div>
</script>
<script type="text/ng-template" id="isLimited.html">
 <div>
   {{dataKylin.model.editDMIsLimitedTip}}
 </div>
</script>
