<!--
* Licensed to the Apache Software Foundation (ASF) under one
* or more contributor license agreements.  See the NOTICE file
* distributed with this work for additional information
* regarding copyright ownership.  The ASF licenses this file
* to you under the Apache License, Version 2.0 (the
* "License"); you may not use this file except in compliance
* with the License.  You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
-->

<div ng-controller="CubeDimensionsCtrl">
<ng-form name="forms.cube_dimension_form" novalidate>
<!-- Dimensions Summary -->
    <div class="dataTables_wrapper form-inline no-footer">
        <div class="row">
            <div class="col-xs-6" ng-if="state.mode=='edit'">
                <button type="button" class="btn btn-info" ng-disabled="!metaModel.model.fact_table.length||instance.status=='READY'"
                        ng-click="openAutoGenModal()" >
                    <i class="fa fa-building-o"></i> {{dataKylin.cube.cubeDSAddDimensions}}
                </button>
            </div>
            <div ng-class="(state.mode=='edit')?'col-xs-6':'col-xs-12'">
                <span class="pull-right input-icon input-icon-right nav-search" style="margin-left: 22px;">
                    <input type="text" placeholder="{{dataKylin.monitor.plac_jobsCubeName}}" class="nav-search-input" ng-model="dimState.filter"/>
                    <i class="ace-icon fa fa-search nav-search-icon"></i>
                </span>
            </div>
        </div>
        <table class="table table-striped table-hover" ng-if="cubeMetaFrame.dimensions.length > 0">
            <thead>
                <tr>
                    <th>{{dataKylin.cube.cubeDSID}}</th>
                    <th>{{dataKylin.cube.cubeDSName}}</th>
                    <th>{{dataKylin.cube.cubeDSType}}</th>
                    <th>{{dataKylin.cube.cubeDSTableName}}</th>
                    <th>{{dataKylin.cube.cubeDSColumn}}</th>
                    <th class="wid-100">{{dataKylin.cube.cubeDSDatatype}}</th>
                    <th>{{dataKylin.cube.cubeDSCardinality}}</th>
                    <th>{{dataKylin.cube.cubeDSComment }}</th>
                    <th ng-if="state.mode=='edit'">{{dataKylin.cube.cubeDSActions}}</th>
                </tr>
            </thead>
            <tbody class="cube-dimension">
                <tr ng-repeat="dimension in cubeMetaFrame.dimensions | filter:dimState.filter track by $index">
                    <!--ID -->
                    <td>
                        <b>{{($index + 1)}}</b>
                    </td>
                    <!--Name -->
                    <td>
                        <span>{{dimension.name}}</span>
                    </td>
                    <!--Type-->
                    <td>
                      <span class="label label-primary" ng-repeat="t in getDimType(dimension)">{{t}}</span>
                    </td>
                    <!--Table Name -->
                    <td>
                      <span>{{dimension.table}}</span>
                    </td>
                    <!--Columns-->
                    <td>
                        <div ng-repeat="t in getDimType(dimension)">
                            <div ng-switch="t">
                                <div class="dl-horizontal" ng-switch-when="derived">
                                    {{dimension.derived}}
                                </div>
                                <div class="dl-horizontal" ng-switch-when="normal">
                                    {{dimension.column}}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div ng-repeat="t in getDimType(dimension)">
                            <div ng-switch="t">
                                <div class="dl-horizontal" ng-switch-when="derived">
                                  {{metaModel.model.aliasColumnMap[dimension.table+"."+dimension.derived].datatype}}
                                </div>
                                <div class="dl-horizontal" ng-switch-when="normal">
                                  {{metaModel.model.aliasColumnMap[dimension.table+"."+dimension.column].datatype}}
                                </div>
                            </div>
                        </div>
                    </td>
                    <!--Cardinality-->
                    <td>
                        <div ng-repeat="t in getDimType(dimension)">
                            <div ng-switch="t">
                                <div class="dl-horizontal" ng-switch-when="derived">
                                  {{metaModel.model.aliasColumnMap[dimension.table+"."+dimension.derived].cardinality}}
                                </div>
                                <div class="dl-horizontal" ng-switch-when="normal">
                                  {{metaModel.model.aliasColumnMap[dimension.table+"."+dimension.column].cardinality}}
                                </div>
                            </div>
                        </div>
                    </td>
                    <!--Comment-->
                    <td>
                        <div ng-repeat="t in getDimType(dimension)">
                            <div ng-switch="t">
                                <div class="dl-horizontal" ng-switch-when="derived">
                                    {{metaModel.model[dimension.table+"."+dimension.derived].comment}}
                                </div>
                                <div class="dl-horizontal" ng-switch-when="normal">
                                    {{metaModel.model[dimension.table+"."+dimension.column].comment}}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td ng-if="state.mode=='edit'">
                        <!--edit button-->
                        <button class="btn btn-xs btn-info" ng-disabled="instance.status=='READY'"
                                ng-click="editDim(dimension)"><i class="fa fa-pencil"></i>
                        </button>
                        <!-- remove button-->
                        <button class="btn btn-xs btn-danger" ng-disabled="instance.status=='READY'"
                                ng-click="removeDim(dimension)"><i class="fa fa-trash-o"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="space-16"></div>
    <div class="callout callout-warning dimensions-conflict-area" ng-if="dimConflicts.length">
        <h4 ng-bind-html="dataKylin.cube.info_no_following_columns"></h4>
        <div class="row" ng-repeat="c in dimConflicts">
            <div class="col-xs-3">
                <code>{{c.table}}.{{c.column}}</code>
            </div>
            <div class="col-xs-3">
                <ul class="list-unstyled">
                    <li ng-repeat="d in c.dims">{{$index +1}} - {{d.name}}</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Edit Dimension Form -->
    <script type="text/ng-template" id="editDimension.html">
        <div class="modal-header">
            <h4 class="box-title lighter">{{dataKylin.cube.cubeDSEditDSEdit}}
            </h4>
        </div>
        <div class="modal-body">
            <ng-form name="edit_dim_form">
            <div class="row">
                <div class="col-xs-8">

                    <!--Table Name: derived dimension only allows lookup tables-->
                    <div >
                        <div  class="row">
                            <label class="control-label col-xs-12 col-sm-3 no-padding-right font-color-default">
                              <b>{{dataKylin.cube.cubeDSTableName}}</b>
                            </label>
                            <div class="col-xs-12 col-sm-6" >
                                <span>{{newDimension.table}}</span>
                            </div>
                            <div class="col-xs-12 col-sm-3">
                                <div class="text-info" ng-if="dimType.indexOf('derived') >= 0">
                                    {{dataKylin.cube.tip_derived_dimension}}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--Normal Dimension: choose one column-->
                    <div  ng-if="dimType.indexOf('normal') >= 0">
                        <div class="row">
                            <label class="control-label col-xs-12 col-sm-3 no-padding-right font-color-default">
                              <b>{{dataKylin.cube.cubeDSColumnName}}</b>
                            </label>
                            <div class="col-xs-12 col-sm-6">
                              <span>{{newDimension.column}}</span>
                            </div>
                        </div>
                    </div>

                    <!--Derived Dimension-->
                    <div  ng-if="dimType.indexOf('derived') >= 0">
                        <div  class="row">
                            <label class="control-label col-xs-12 col-sm-3 no-padding-right font-color-default">
                                <b>{{dataKylin.cube.cubeDSColumnName}}</b>
                            </label>
                            <div class="col-xs-12 col-sm-6">
                                <div ng-repeat="derived in newDimension.derived track by $index">
                                    <span class="label label-info">
                                       {{newDimension.derived[$index]}}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div  ng-if="availableFactTables.indexOf(newDimension.table)==-1">
                        <div  class="row">
                            <label class="control-label col-xs-12 col-sm-3 no-padding-right font-color-default">
                                <b>{{dataKylin.cube.cubeDSType}}</b>
                            </label>
                            <div class="col-xs-12 col-sm-6">
                                <label>
                                      <input type="radio" ng-model="editDimension.normal" value="true" > {{dataKylin.cube.cubeDSNormal}}
                                </label>
                                <label>
                                      <input type="radio" ng-model="editDimension.normal" value="false" > {{dataKylin.cube.cubeDSDerived}}
                                </label>
                             </div>
                        </div>
                    </div>
                  <!--Name-->
                    <div >
                        <div class="row">
                            <label class="col-xs-12 col-sm-3 control-label no-padding-right font-color-default"><b>{{dataKylin.cube.cubeDSName}}</b></label>
                            <div class="col-xs-12 col-sm-6">
                                <input type="text" placeholder="{{dataKylin.cube.tip_cubeDSName}}" class="form-control" name="dim_name"
                                        ng-model="newDimension.name" required />
                            </div>
                            <div class="col-xs-12 col-sm-3">
                                <div class="text-warning" ng-if="edit_dim_form.dim_name.$error.required  && edit_dim_form.dim_name.$dirty">
                                    {{dataKylin.cube.tip_no_dimension_name}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--Tips-->
                <div class="col-xs-4">
                    <div class="box box-solid">
                        <div class="box-header">
                            <h4 class="box-title">{{dataKylin.cube.tip_title_cubeDS}}</h4>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-xs-12">
                                    <ol class="text-info" ng-bind-html="dataKylin.cube.tip_body_cubeDS">
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </ng-form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" ng-click="cancel()">{{dataKylin.cube.ac_cancel_cube}}</button>
            <button class="btn btn-success" ng-disabled="edit_dim_form.$invalid" ng-click="checkDimension()?ok():''">{{dataKylin.cube.ac_ok_cube}}</button>
        </div>
    </script>


    <script type="text/ng-template" id="addDimension.html">
        <div class="modal-header large-popover">
          <h4 class="box-title lighter">{{dataKylin.cube.cubeDSAutoGenerate_part_one}} <i kylinpopover placement="right" ng-title="{{dataKylin.cube.tip_title_DSAutoGenerate}}" template="DimensionsTip.html" class="fa fa-info-circle"></i> <small>{{dataKylin.cube.cubeDSAutoGenerate_part_two}}</small></h4>
          <div class="col-xs-12">
            {{dataKylin.cube.tip_visit}} <a href="http://kylin.apache.org/docs/howto/howto_optimize_cubes.html" target="_blank">{{dataKylin.cube.cubeDSDerived}}</a> {{dataKylin.cube.tip_about_derived_column}}
          </div>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-xs-12">
                    <div class="box box-solid">
                        <div class="box-body">
                           <ul class="list-unstyled columns-region">
                              <!--FactTable-->
                              <div ng-repeat="table in availableFactTables track by $index"  class="panel-default " >
                                 <h4>{{table}}{{dataKylin.cube.cubeDSFactTable}}</h4>
                                 <table class="table table-striped table-hover ng-scope" >
                                       <tr>
                                          <td style="width:10%"><label><input type="checkbox" ng-model="selectedColumns[table].all" ng-change="autoChangeAll(table)">&nbsp;&nbsp;{{dataKylin.cube.cubeDSSelectAll}}</label></td>
                                          <td style="width:22%"><label>{{dataKylin.cube.cubeDSName}}</label></td>
                                          <td style="width:18%"><label>{{dataKylin.cube.cubeDSColumns}}</label></td>
                                          <td style="width:15%"><label>{{dataKylin.cube.cubeDSDatatype}}</label></td>
                                          <td style="width:15%"><label>{{dataKylin.cube.cubeDSCardinality}}</label></td>
                                          <td colspan="2" style="width:20%"></td>
                                       </tr>
                                       <tr ng-repeat="col in availableColumns[table] track by col.table + '.' + col.name" >
                                          <td>
                                            <label class="dim-checkbox-label">
                                              <input type="checkbox" ng-model="selectedColumns[table][col.name].selected" ng-change="autoChange(table,col.name)">
                                            </label>
                                          </td>
                                          <td>
                                             <input type="text"  placeholder={{col.name}} ng-model="selectedColumns[table][col.name].name" ng-disabled="!selectedColumns[table][col.name].selected" style="width:90%;">
                                          </td>
                                          <td>
                                             {{col.name}}
                                          </td>
                                          <td>
                                             {{metaModel.model.aliasColumnMap[table+"."+col.name].datatype}}
                                          </td>
                                          <td>
                                             {{metaModel.model.aliasColumnMap[table+"."+col.name].cardinality}}
                                          </td>
                                          <td colspan="2"></td>
                                       </tr>
                                    </table>
                                 </div>
                                 <!--LookUp Table-->
                                 <div ng-repeat="table in availableLookupTables track by $index" ng-if="$index > 0"  class="panel-default" heading="{{table}}{{dataKylin.cube.cubeDSLookupTable}}">
                                    <table class="table table-striped table-hover ng-scope">
                                       <h4>{{table}}{{dataKylin.cube.cubeDSLookupTable}}</h4>
                                       <tr class="row" >
                                         <td style="width:10%"><label><input type="checkbox" ng-model="selectedColumns[table].all" ng-change="autoChangeAll(table)">&nbsp;&nbsp;{{dataKylin.cube.cubeDSSelectAll}}</label></td>
                                         <td style="width:22%"><label>{{dataKylin.cube.cubeDSName}}</label></td>
                                         <td style="width:18%"><label>{{dataKylin.cube.cubeDSColumns}}</label></td>
                                         <td style="width:15%"><label>{{dataKylin.cube.cubeDSDatatype}}</label></td>
                                         <td style="width:15%"><label>{{dataKylin.cube.cubeDSCardinality}}</label></td>
                                         <td colspan="2" style="width:20%;text-align:center;"><label>{{dataKylin.cube.cubeDSType}}</label></td>
                                       </tr>
                                       <tr ng-repeat="col in availableColumns[table] track by col.table + '.' + col.name" class="row">
                                          <td>
                                            <label class="dim-checkbox-label">
                                              <input type="checkbox" ng-model="selectedColumns[table][col.name].selected" ng-change="autoChange(table,col.name)">
                                            </label>
                                          </td>
                                          <td >
                                             <input type="text" ng-model="selectedColumns[table][col.name].name"  ng-disabled="!selectedColumns[table][col.name].selected" style="width:90%;">
                                          </td>
                                          <td >
                                             {{col.name}}
                                          </td>
                                          <td>
                                            {{metaModel.model.aliasColumnMap[table+"."+col.name].datatype}}
                                          </td>
                                          <td>
                                            {{metaModel.model.aliasColumnMap[table+"."+col.name].cardinality}}
                                          </td>
                                          <td>
                                             <label> <input type="radio" ng-model="selectedColumns[table][col.name].normal" value="true" ng-disabled="!selectedColumns[table][col.name].selected"> {{dataKylin.cube.cubeDSNormal}} </label>
                                          </td>
                                          <td>
                                             <label> <input type="radio" ng-model="selectedColumns[table][col.name].normal" value="false" ng-disabled="!selectedColumns[table][col.name].selected"> {{dataKylin.cube.cubeDSDerived}} </label>
                                          </td>
                                       </tr>
                                    </table>
                                 </div>
                          </ul>
                        </div>
                    </div>
                </div>


            </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" ng-click="cancel()">{{dataKylin.cube.ac_cancel_cube}}</button>
            <button class="btn btn-success" ng-disabled="" ng-click="checkAutoDimension()?ok():''">{{dataKylin.cube.ac_ok_cube}}</button>

        </div>
    </script>
    </ng-form>
</div>
<script type="text/ng-template" id="DimensionsTip.html">
      <div ng-bind-html="dataKylin.cube.tip_body_DSAutoGenerate">
      </div>
</script>
