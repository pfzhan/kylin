
<!--
* Licensed to the Apache Software Foundation (ASF) under one
* or more contributor license agreements.  See the NOTICE file
* distributed with this work for additional information
* regarding copyright ownership.  The ASF licenses this file
* to you under the Apache License, Version 2.0 (the
* "License"); you may not use this file except in compliance
* with the License.  You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
-->

<!-- Measures Summary -->
<div ng-controller="CubeMeasuresCtrl">
  <ng-form name="forms.cube_measure_form">
    <div class="dataTables_wrapper form-inline no-footer" ng-if="cubeMetaFrame.measures.length > 0">
      <table class="table table-striped table-hover">
        <thead>
        <tr>
          <th>{{dataKylin.cube.cubeMSName}}</th>
          <th>{{dataKylin.cube.cubeMSExpression}}</th>
          <th>{{dataKylin.cube.cubeMSParameters}}</th>
          <th>{{dataKylin.cube.cubeDSDatatype}}</th>
          <th>{{dataKylin.cube.cubeDSComment }}</th>
          <th>{{dataKylin.cube.cubeMSReturnType}}</th>
          <th ng-if="state.mode=='edit'">{{dataKylin.cube.cubeMSActions}}</th>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="measure in cubeMetaFrame.measures | filter: state.measureFilter track by $index">
          <td>
            <!--Name -->
            <span tooltip="measure name..">{{measure.name}}</span>
          </td>
          <td>
            <!--Expression -->
            <span>{{measure.function.expression}}</span>
          </td>
          <td>
            <div class="paraTree">
              <ul>
                <parametertree ng-if="measure.function.parameter!=null && measure.function.expression!=='TOP_N' && measure.function.expression!=='EXTENDED_COLUMN'" nextpara="measure.function.parameter"></parametertree>
                <topntree ng-if="measure.function.parameter!=null && measure.function.expression=='TOP_N'" nextpara="measure.function.parameter"></topntree>
                <extendedcolumntree ng-if="measure.function.parameter!=null && measure.function.expression=='EXTENDED_COLUMN'" nextpara="measure.function.parameter"></extendedcolumntree>
              </ul>
            </div>
            <!--<span ng-if="measure.function.parameter.next_parameter!=null">{{measure.function.parameter.next_parameter |json}}</span>-->
          </td>
          <td >
            {{metaModel.model.aliasColumnMap[measure.function.parameter.value].datatype}}
          </td>
          <td >
            {{metaModel.model.aliasColumnMap[+measure.function.parameter.value].comment}}
          </td>
          <td>
            <!--Return Type -->
            <span>{{measure.function.returntype}}</span>
          </td>
          <td ng-if="state.mode=='edit'">
            <!--Edit Button -->
            <button class="btn btn-xs btn-info" ng-click="editMeasure(measure,$index)" ng-disabled="instance.status=='READY'">
              <i class="fa fa-pencil"></i>
            </button>
            <!--Remove Button -->
            <button class="btn btn-xs  btn-danger" ng-click="removeElement(cubeMetaFrame.measures, measure)" ng-disabled="instance.status=='READY'">
              <i class="fa fa-trash-o"></i>
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </ng-form>

  <!--Add Measures Button-->
  <div class="form-group">
    <button class="btn btn-sm btn-info" ng-click="addMeasure()" ng-show="state.mode=='edit'"  ng-disabled="instance.status=='READY'">
       {{dataKylin.model.Measure}}&nbsp;<i class="fa fa-plus"></i>
    </button>
  </div>

  <!--Edit Measure-->
  <script type="text/ng-template" id="addEditDimension.html" >
   <ng-form name="edit_mes_form" >

      <div class="modal-header">
        <h4 class="box-title lighter">{{dataKylin.cube.cubeMSEditMS}}</h4>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-xs-8">
            <!--Name-->
            <div class="form-group">
              <div class="row">
                <label class="col-xs-12 col-sm-3 control-label no-padding-right font-color-default"><b>{{dataKylin.cube.cubeMSName}}</b></label>
                <div class="col-xs-12 col-sm-6">
                  <input type="text" placeholder="{{dataKylin.cube.cubeMSName}}.." class="form-control"
                         tooltip="{{dataKylin.cube.cubeMSMeasureName}}" tooltip-trigger="focus"
                         ng-model="newMeasure.name" required />
                </div>
              </div>
            </div>
            <!--Expression-->
            <div class="form-group middle-popover">
              <div class="row">
                <label class="col-xs-12 col-sm-3 control-label no-padding-right font-color-default"><b>{{dataKylin.cube.cubeMSExpression}}</b><i class="fa fa-info-circle" kylinpopover placement="right" ng-title="{{dataKylin.cube.cubeMSExpression}}" template="expressionTip.html"></i></label>
                <div class="col-xs-12 col-sm-6">
                  <select class="form-control"
                          ng-init="newMeasure.function.expression = (!!newMeasure.function.expression)?newMeasure.function.expression:cubeConfig.dftSelections.measureExpression" chosen ng-model="newMeasure.function.expression" required
                          ng-change="measureReturnTypeUpdate(); measureParamValueUpdate();"
                          ng-options="me as me for me in cubeConfig.measureExpressions">
                    <option value=""></option>
                  </select>
                </div>
              </div>
            </div>
            <!--Param Type-->
            <div class="form-group" ng-if="newMeasure.function.expression !== 'EXTENDED_COLUMN'">
              <div class="row">
                <label class="col-xs-12 col-sm-3 control-label no-padding-right font-color-default"><b>{{dataKylin.cube.cubeMSParamType}}</b></label>
                <div class="col-xs-12 col-sm-6">
                  <select class="form-control" ng-if="newMeasure.function.expression != 'COUNT'&&newMeasure.function.expression != 'PERCENTILE'"
                          ng-init="newMeasure.function.parameter.type=(!!newMeasure.function.parameter.type)?newMeasure.function.parameter.type: 'column' "
                          chosen ng-model="newMeasure.function.parameter.type" required
                          ng-change="measureReturnTypeUpdate();"
                          ng-options="mpt as mpt for mpt in cubeConfig.measureParamType">
                    <option value=""></option>
                  </select>
                  <span class="font-color-default"
                        ng-if="newMeasure.function.expression == 'COUNT'||newMeasure.function.expression == 'PERCENTILE'">
                    <b>&nbsp;&nbsp;{{newMeasure.function.parameter.type}}&nbsp;&nbsp;</b>
                  </span>
                </div>
              </div>
            </div>
            <!--Param Value-->
            <div class="form-group middle-popover">
              <div class="row">
                <label class="col-xs-12 col-sm-3 control-label no-padding-right font-color-default">
                  <b ng-if="newMeasure.function.expression == 'EXTENDED_COLUMN'">Host column On Fact Table</b>  <i ng-if="newMeasure.function.expression == 'EXTENDED_COLUMN'" title="Host Column" class="fa fa-info-circle" kylinpopover placement="right" template="hostTableTip.html"></i>
                  <b ng-if="newMeasure.function.expression == 'TOP_N'">ORDER|SUM by Column</b>  <i ng-if="newMeasure.function.expression == 'TOP_N'" class="fa fa-info-circle" title="ORDER|SUM by Column" kylinpopover placement="right" template="topnTip.html"></i>
                  <b ng-if="newMeasure.function.expression !== 'EXTENDED_COLUMN' && newMeasure.function.expression !== 'TOP_N' ">{{dataKylin.model.paramValue}}</b>  <i ng-if="newMeasure.function.expression !== 'EXTENDED_COLUMN' && newMeasure.function.expression !== 'TOP_N' " class="fa fa-info-circle" kylinpopover placement="right" ng-title="{{dataKylin.cube.cubeMSParamValue}}" template="paramvalueTip.html"></i>
                  <!--tip for top_n-->
                  <!--<small ng-if="newMeasure.function.expression == 'TOP_N'" class="help-block" style="color:#3a87ad">(SUM|ORDER BY Column for TOP_N)</small>-->
                </label>

                <div class="col-xs-12 col-sm-6">
                  <span class="font-color-default"
                        ng-if="newMeasure.function.parameter.type == 'constant'"
                        ng-init="newMeasure.function.parameter.value = 1">
                    <b>&nbsp;&nbsp;1</b>
                  </span>
                  <div  style="width:100%;" class="chosen-container chosen-container-single" ng-if="newMeasure.function.parameter.type == 'column'">
                    <button style="width:100%;" type="button" class="chosen-single dropdown-toggle" data-toggle="dropdown">
                      <span style="float:left;" ng-show="newMeasure.function.parameter.value && newMeasure.function.parameter.value!=1" >{{newMeasure.function.parameter.value}}</span>
                      <span class="align-right" ng-show="newMeasure.function.parameter.value && newMeasure.function.parameter.value!=1">{{metaModel.model.aliasColumnMap[newMeasure.function.parameter.value].datatype}}</span>
                      <span style="float:left;" ng-show="!newMeasure.function.parameter.value || newMeasure.function.parameter.value==1" >{{dataKylin.cube.cubeMSParamValueSelect}}</span>
                      <div><b></b></div>
                    </button>
                    <ul class="dropdown-menu my-dropdown" role="menu"  style="width:100%;height:200px;overflow-y:scroll;" >
                      <li>
                        <div class="chosen-search" ng-click="$event.stopPropagation();">
                          <input type="text" ng-model="colsFilter" >
                        </div>
                        <a ng-repeat="column in measureParamValueColumn|filter:colsFilter" class="active-result"
                           ng-click="newMeasure.function.parameter.value=column;measureReturnTypeUpdate();" >
                          <span>{{column}}</span>
                          <span style="float:right;" >{{metaModel.model.aliasColumnMap[column].datatype}}</span>
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
                <label ng-if="newMeasure.function.parameter.type == 'column'&& newMeasure.function.expression !== 'EXTENDED_COLUMN'">
                  <input type="checkbox" ng-model="newMeasure.showDim" ng-change="measureParamValueUpdate();" />&nbsp;{{dataKylin.cube.includeDimension}}
                </label>
              </div>
            </div>


            <div class="form-group middle-popover" ng-if="newMeasure.function.expression == 'EXTENDED_COLUMN'">
              <div class="row">
                <label class="col-xs-12 col-sm-3 control-label no-padding-right font-color-default">
                  <b>Extended column on fact table</b>    <i ng-if="newMeasure.function.expression == 'EXTENDED_COLUMN'" title="Extended Column" class="fa fa-info-circle" kylinpopover placement="right" template="extendedColumnTip.html"></i>
                </label>
                <div class="col-xs-12 col-sm-6">
                  <div  style="width:100%;" class="chosen-container chosen-container-single">
                    <button style="width:100%;" type="button" class="chosen-single dropdown-toggle" data-toggle="dropdown">
                      <span style="float:left;" ng-show="nextPara.value && nextPara.value!=1" >{{nextPara.value}}</span>
                      <span class="align-right" ng-show="nextPara.value && nextPara.value!=1">{{metaModel.model.aliasColumnMap[nextPara.value].datatype}}</span>
                      <span style="float:left;" ng-show="!nextPara.value || nextPara.value==1" >{{dataKylin.cube.cubeMSParamValueSelect}}</span>
                      <div><b></b></div>
                    </button>
                    <ul class="dropdown-menu my-dropdown" role="menu"  style="width:100%;height:200px;overflow-y:scroll;" >
                      <li>
                        <div class="chosen-search" ng-click="$event.stopPropagation();">
                          <input type="text" ng-model="nextParaFilter" >
                        </div>
                        <a ng-repeat="column in getAllModelDimColumns()|filter:nextParaFilter" class="active-result"
                           ng-click="nextPara.value=column" >
                          <span>{{column}}</span>
                          <span style="float:right;" >{{metaModel.model.aliasColumnMap[column].datatype}}</span>
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <!--Return Type-->
            <div class="form-group middle-popover">
              <div class="row">
                <label ng-if="newMeasure.function.expression !== 'EXTENDED_COLUMN'" class="col-xs-12 col-sm-3 control-label no-padding-right font-color-default"><b>{{dataKylin.cube.cubeMSReturnType}}</b></label>
                <label ng-if="newMeasure.function.expression == 'EXTENDED_COLUMN'" class="col-xs-12 col-sm-3 control-label no-padding-right font-color-default">
                  <b>Maximum length of extended column</b>  <i ng-if="newMeasure.function.expression == 'EXTENDED_COLUMN'" title="Maximum Length" class="fa fa-info-circle" kylinpopover placement="right" template="extendedTypeTip.html"></i>
                </label>
                <div class="col-xs-12 col-sm-6">
                  <select class="form-control"
                          ng-if="newMeasure.function.expression == 'COUNT_DISTINCT'"
                          ng-init="newMeasure.function.returntype = (!!newMeasure.function.returntype)?newMeasure.function.returntype:cubeConfig.dftSelections.distinctDataType.value"
                          chosen ng-model="newMeasure.function.returntype" required
                          ng-options="ddt.value as ddt.name for ddt in cubeConfig.distinctDataTypes">
                    <option value=""></option>
                  </select>
                  <select class="form-control"
                          ng-if="newMeasure.function.expression == 'TOP_N'"
                          ng-init="newMeasure.function.returntype = (!!newMeasure.function.returntype)?newMeasure.function.returntype:cubeConfig.dftSelections.topN.value"
                          chosen ng-model="newMeasure.function.returntype" required
                          ng-options="ddt.value as ddt.name for ddt in cubeConfig.topNTypes">
                    <option value=""></option>
                  </select>

                  <input extended-column-return
                         ng-if="newMeasure.function.expression == 'EXTENDED_COLUMN'"
                         type="text" placeholder="Kylin won’t save more than this number of bytes" class="form-control"
                         tooltip-trigger="focus"
                         ng-init="newMeasure.function.returntype=newMeasure.function.returntype?newMeasure.function.returntype:'extendedcolumn(100)'"
                         ng-model="newMeasure.function.returntype" required />

                                  <span class="font-color-default"
                                        ng-if="newMeasure.function.expression != 'COUNT_DISTINCT' && newMeasure.function.expression != 'TOP_N' && newMeasure.function.expression != 'EXTENDED_COLUMN' "
                                  ><b>&nbsp;&nbsp;{{newMeasure.function.returntype | uppercase}}</b>
                                  </span>
                </div>
              </div>
            </div>

            <!--Group by Column-->
            <div class="form-group" ng-if="newMeasure.function.expression == 'TOP_N'">
              <div class="row">
                <label class="col-xs-12 col-sm-3 control-label no-padding-right font-color-default">
                  <b>Group by Column</b>
                </label>
                <div class="form-group large-popover" >
                  <div class="box-body">
                    <table style="margin-left:width:92%"
                           class="table table-hover table-bordered list">
                      <thead>
                        <tr>
                          <th style="width:40px;">{{dataKylin.cube.cubeMSID}}</th>
                          <th>{{dataKylin.cube.cubeMSColumn}}</th>
                          <th style="width:190px;">{{dataKylin.cube.cubeMSEncoding}}</th>
                          <th style="width:190px;">{{dataKylin.cube.cubeMSLength}}</th>
                          <th ng-if="state.mode=='edit'"></th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr ng-repeat="groupby_column in convertedColumns track by $index"
                            ng-class="state.mode=='edit'?'sort-item':''">

                          <td>
                            <!-- ID -->
                            <span class="ng-binding" ng-class="state.mode=='edit'?'badge':''">{{($index + 1)}}</span>
                          </td>
                          <!--Column Name -->
                          <td>
                            <select class="form-control col-xs-12" chosen ng-if="nextPara.type !== 'constant'" required
                                    ng-model="groupby_column.name"
                                    ng-options="column as column for column in getAllModelDimColumns()" >
                              <option value="">{{dataKylin.cube.cubeMSParamValueSelect}}</option>
                            </select>
                          </td>
                          <!--Column Encoding -->
                          <td>
                            <div  style="width:100%;" class="chosen-container chosen-container-single ">
                              <button style="width:100%;" type="button" class="chosen-single dropdown-toggle" data-toggle="dropdown">
                                <span style="float:left;" >{{groupby_column.encodingName}}</span>
                              </button>
                              <ul class="dropdown-menu my-dropdown" role="menu"  style="width:100%;" >
                                <li>
                                  <a middle-popover ng-repeat="encoding in getEncodings(groupby_column.name)" ng-click="groupby_column.encoding=encoding.value;groupby_column.encodingName=encoding.name;"
                                     kylinpopover placement="right" ng-version="{{integerVersion.version}}"
                                     ng-title="{{(encoding.value=='dict[v1]'||encoding.value=='fixed_length[v1]'||encoding.value=='int[v1]'||encoding.value=='integer[v1]'||encoding.value=='integer[v2]'||encoding.value=='fixed_length_hex[v1]'||encoding.value=='date[v1]'||encoding.value=='time[v1]'||encoding.value=='boolean[v1]')?encoding.name:''}}" ng-value="{{encoding.value}}" ng-watch="{{dataKylin.cube.tip_encoding}}" template="encodingTip.html">
                                    {{encoding.name}}
                                  </a>
                                </li>
                              </ul>
                            </div>
                            <span ng-if="state.mode=='view'">{{groupby_column.encoding}}</span>
                          </td>
                          <td>
                            <!--Column Length -->
                            <input type="text" class="form-control" placeholder="Column Length.." ng-if="state.mode=='edit'"
                                   ng-change="refreshGroupBy(convertedColumns,$index,groupby_column);"
                                   ng-disabled="groupby_column.encoding.indexOf('dict')>=0||groupby_column.encoding.indexOf('date')>=0||groupby_column.encoding.indexOf('time')>=0"
                                   ng-model="groupby_column.valueLength" class="form-control"
                                   placement="top" ng-name="{{groupby_column.encoding}}"  ng-value="{{groupby_column.valueLength}}"
                                   ng-watch="{{dataKylin.cube.tip_length}}" template="lengthTip.html" ng-version="{{integerVersion.version}}"
                                   kylinpopover  ng-title="{{(groupby_column.encoding=='fixed_length[v1]'||groupby_column.encoding=='integer[v1]'||groupby_column.encoding=='fixed_length_hex[v1]')?groupby_column.encodingName:''}}" >
                            <span ng-if="state.mode=='view'">{{groupby_column.valueLength}}</span>
                          </td>
                          <td ng-if="state.mode=='edit'">
                            <button class="btn btn-xs btn-info"
                                    ng-click="removeColumn(convertedColumns, $index)"><i
                              class="fa fa-minus"></i>
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <button class="btn btn-sm btn-info" style="margin-left:10px"
                          ng-click="addNewGroupByColumn()" ng-show="state.mode=='edit'">{{dataKylin.cube.cubeMSNewColumn}}<i class="fa fa-plus"></i>
                  </button>
                </div>
              </div>
            </div>

            <!--Name-->
            <div class="form-group">
              <div class="row">
                <label class="col-xs-12 col-sm-3 control-label no-padding-right font-color-default"><b></b></label>
                <div class="col-xs-12 col-sm-6">
                  <table class="table table-hover table-bordered list" ng-if="nextParameters.length" ng-show="newMeasure.function.expression != 'TOP_N'">
                    <tr>
                      <th>{{dataKylin.cube.cubeMSType}}</th>
                      <th>{{dataKylin.cube.cubeMSValue}}</th>
                      <th></th>
                    </tr>
                    <tr ng-repeat="n_parameter in nextParameters track by $index">
                      <td>{{n_parameter.type}}</td>
                      <td>{{n_parameter.value}}</td>
                      <td>
                        <button class="btn btn-xs btn-info" ng-click="editNextParameter(n_parameter)">
                          <i class="fa fa-pencil"></i>
                        </button>
                        <button class="btn btn-xs btn-info" ng-click="removeParameter(nextParameters, $index)"><i class="fa fa-minus"></i>
                        </button>
                      </td>
                    </tr>
                  </table>

                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-default" ng-click="cancel()">{{dataKylin.cube.cubeMSCancel}}</button>
        <button class="btn btn-success" ng-disabled="edit_mes_form.$invalid"
                ng-click="checkMeasure()?ok():''" ng-show="state.mode=='edit'">{{dataKylin.cube.cubeMSOK}}</button>
      </div>
  </ng-form>
 </script>
</div>





<script type="text/ng-template" id="expressionTip.html">
  <p>{{dataKylin.cube.tip_cubeMSExpression}}</p>
</script>
<script type="text/ng-template" id="paramvalueTip.html">
  <ol ng-bind-html="dataKylin.cube.tip_cubeMSParamValue">
  </ol>
</script>

<script type="text/ng-template" id="extendedTypeTip.html">
  <p>
    {{dataKylin.cube.tip_extendedType}}
  </p>
</script>

<script type="text/ng-template" id="topnTip.html">
  <p>
    {{dataKylin.cube.tip_topn}}
  </p>
</script>

<script type="text/ng-template" id="hostTableTip.html">
  <p>{{dataKylin.cube.tip_hostcolumn}}</p>
</script>
<script type="text/ng-template" id="extendedColumnTip.html">
  <p>
  <p>{{dataKylin.cube.tip_extendedcolumn}}</p>
  </p>
</script>
<script type="text/ng-template" id="encodingTip.html" >
  <div >
    <div ng-if="value=='dict[v1]'">
      {{dataKylin.cube.tip_encoding_dict}}
    </div>
    <div ng-if="value=='fixed_length[v1]'">
      {{dataKylin.cube.tip_encoding_fixed_length}}
    </div>
    <div ng-if="value=='boolean[v1]'">
      {{dataKylin.cube.tip_encoding_bool}}
    </div>
    <div ng-if="value=='int[v1]'">
      {{dataKylin.cube.tip_encoding_int}}
    </div>
    <div ng-if="value=='integer[v1]'&&version>value.substring(9,10)">
      {{dataKylin.cube.tip_encoding_integer_v1}}
    </div>
    <div ng-if="value=='integer[v1]'&&version==value.substring(9,10)">
      {{dataKylin.cube.tip_encoding_integer_v2}}
    </div>
    <div ng-if="value=='integer[v2]'">
      {{dataKylin.cube.tip_encoding_integer_v2}}
    </div>
    <div ng-if="value=='fixed_length_hex[v1]'">
      {{dataKylin.cube.tip_encoding_fixed_length_hex}}
    </div>
    <div ng-if="value=='date[v1]'">
      {{dataKylin.cube.tip_encoding_date}}
    </div>
    <div ng-if="value=='time[v1]'">
      {{dataKylin.cube.tip_encoding_time}}
    </div>
  </div>
</script>
<script type="text/ng-template" id="lengthTip.html">
  <div >
    <div ng-if="name=='fixed_length[v1]'">
      {{dataKylin.cube.tip_length_fixed_length_part_one}}
      {{value}}
      {{dataKylin.cube.tip_length_fixed_length_part_two}}
    </div>
    <div ng-if="name=='integer[v1]'">
      {{dataKylin.cube.tip_length_integer_v2}}
      [{{-Math.pow(2,(8*value-1))}},{{Math.pow(2,(8*value-1))}}]
      <small class="help-block red" ng-show="value>8||value<1">{{dataKylin.alert.check_cube_rowkeys_int}}</small>
    </div>
    <div ng-if="name=='fixed_length_hex[v1]'">
      {{dataKylin.cube.tip_length_fixed_length_hex_part_one}}
      {{value*2}}
      {{dataKylin.cube.tip_length_fixed_length_hex_part_two}}
    </div>
  </div>
</script>
