From d658d5bf28787745aa086b4b7a39496d54d9a258 Mon Sep 17 00:00:00 2001
From: luguosheng <550175214@qq.com>
Date: Fri, 14 Oct 2016 17:14:18 +0800
Subject: [PATCH 1/2] rawtable  new edit

---
 webapp/app/js/controllers/cubeEdit.js            | 74 ++++++++++++++----------
 webapp/app/js/controllers/rawTableSettingCtrl.js | 18 ++++--
 2 files changed, 55 insertions(+), 37 deletions(-)

diff --git a/webapp/app/js/controllers/cubeEdit.js b/webapp/app/js/controllers/cubeEdit.js
index 7aa4336..6705356 100755
--- a/webapp/app/js/controllers/cubeEdit.js
+++ b/webapp/app/js/controllers/cubeEdit.js
@@ -380,7 +380,6 @@ KylinApp.controller('CubeEditCtrl', function ($scope, $q, $routeParams, $locatio
     }, function (isConfirm) {
       if (isConfirm) {
         loadingRequest.show();
-
         if ($scope.isEdit) {
           CubeService.update({}, {
             cubeDescData: $scope.state.cubeSchema,
@@ -426,23 +425,17 @@ KylinApp.controller('CubeEditCtrl', function ($scope, $q, $routeParams, $locatio
           //更新rawTable
 
           if($scope.RawTables&&$scope.RawTables.columns){
-            RawTablesService.update({},{
-              rawTableDescData:angular.toJson($scope.RawTables, true),
-              project: $scope.state.project,
-              rawTableName:$scope.RawTables.name
-
-            },function(request){
-
-            },function(request){
+            if($scope.RawTables.needAdd){
+              saveRawTable();
+              return;
+            }
+            updateRawTable();
+          }else if($scope.RawTables.needDelete){
+             RawTablesService.delete({rawTableName:$scope.cubeMetaFrame.name},{},function(){
 
-            })
+             })
           }
-
-
-
         } else {
-
-
           //保存cube
           CubeService.save({}, {
             cubeDescData: $scope.state.cubeSchema,
@@ -453,23 +446,7 @@ KylinApp.controller('CubeEditCtrl', function ($scope, $q, $routeParams, $locatio
               kylinCommon.success_alert($scope.dataKylin.alert.success,$scope.dataKylin.alert.success_created_cube);
               $location.path("/models");
               //location.reload();
-
-              if($scope.RawTables&&$scope.RawTables.columns){
-                //保存rawTable
-                $scope.RawTables.name=$scope.cubeMetaFrame.name;
-                $scope.RawTables.model_name=$scope.cubeMetaFrame.model_name;
-                $scope.RawTables.engine_type=$scope.cubeMetaFrame.engine_type;
-                $scope.RawTables.storage_type=$scope.cubeMetaFrame.storage_type;
-                RawTablesService.save({},{
-                  rawTableDescData:angular.toJson($scope.RawTables, true),
-                  project: $scope.state.project
-                },function(request){
-
-                },function(request){
-
-                })
-              }
-
+              saveRawTable();
             } else {
               $scope.saveCubeRollBack();
               $scope.cubeMetaFrame.project = $scope.state.project;
@@ -508,6 +485,39 @@ KylinApp.controller('CubeEditCtrl', function ($scope, $q, $routeParams, $locatio
 
 
         }
+
+        //保存rawTable
+        function saveRawTable(){
+          if($scope.RawTables&&$scope.RawTables.columns){
+
+            $scope.RawTables.name=$scope.cubeMetaFrame.name;
+            $scope.RawTables.model_name=$scope.cubeMetaFrame.model_name;
+            $scope.RawTables.engine_type=$scope.cubeMetaFrame.engine_type;
+            $scope.RawTables.storage_type=$scope.cubeMetaFrame.storage_type;
+            RawTablesService.save({},{
+              rawTableDescData:angular.toJson($scope.RawTables, true),
+              project: $scope.state.project
+            },function(request){
+
+            },function(request){
+
+            })
+          }
+        }
+
+        //更新rawTable
+        function updateRawTable(){
+          RawTablesService.update({},{
+            rawTableDescData:angular.toJson($scope.RawTables, true),
+            project: $scope.state.project,
+            rawTableName:$scope.RawTables.name
+
+          },function(request){
+
+          },function(request){
+
+          })
+        }
       }
       else {
         $scope.saveCubeRollBack();
diff --git a/webapp/app/js/controllers/rawTableSettingCtrl.js b/webapp/app/js/controllers/rawTableSettingCtrl.js
index e1e2959..8de0966 100644
--- a/webapp/app/js/controllers/rawTableSettingCtrl.js
+++ b/webapp/app/js/controllers/rawTableSettingCtrl.js
@@ -123,15 +123,21 @@ KylinApp.controller('RawTableSettingCtrl', function ($scope, $modal,cubeConfig,M
       RawTablesService.getRawTableInfo({rawTableName: $scope.state.cubeName}, {}, function (request) {
         if(request&&request.columns&&request.columns.length){
           $scope.rawTableColumns = request;
-          if($scope.rawTableColumns&&$scope.rawTableColumns.columns&&$scope.rawTableColumns.columns.length>0){
-            $scope.wantSetting=true;
+          $scope.wantSetting=true;
+          $scope.hasConfig=true;
+        }else{
+          $scope.wantSetting=false;
+          if($scope.isEdit){
+            $scope.rawTableColumns.needAdd=true;
           }
-          transferRawTableData();
         }
-
+        transferRawTableData();
       },function(){
          //$scope.rawTableColumns=[];
          $scope.wantSetting=false;
+          if($scope.isEdit){
+            $scope.rawTableColumns.needAdd=true;
+          }
       })
     }
     $scope.loadRawTable();
@@ -141,7 +147,9 @@ KylinApp.controller('RawTableSettingCtrl', function ($scope, $modal,cubeConfig,M
     if($scope.wantSetting){
       $scope.$emit('RawTableEdited', $scope.rawTableColumns);
     }else{
-      $scope.$emit('RawTableEdited',[]);
+      var data=[];
+      data.needDelete=$scope.hasConfig;
+      $scope.$emit('RawTableEdited',data);
     }
   }
 
-- 
2.9.2

