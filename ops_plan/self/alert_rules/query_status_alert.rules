groups:
- name: query_status_alert
  rules:

  - alert: Query Failed Too Many Times
    expr: round(sum by (job,instance) (delta(ke_queries_seconds_count{succeed="false"}[5m]))) > 20
    for: 1m
    labels:
      severity: signification
    annotations:
      summary: "{{$labels.job}} Instance {{$labels.instance}} query failed too many times"
      description: "{{$labels.job}} Instance {{$labels.instance}} query failed times has been > 20 in last 5 minutes, current failed times: {{ $value }}"

  - alert: Failed Query Ratio Is Too High
    expr: round(sum by (job,instance) (delta(ke_queries_seconds_count{succeed="false"}[5m]))) / round(sum by (job,instance) (delta(ke_queries_seconds_count[5m]))) > 0.05
    for: 2m
    labels:
      severity: signification
    annotations:
      summary: "{{$labels.job}} Instance {{$labels.instance}} failed query ratio is too high"
      description: "{{$labels.job}} Instance {{$labels.instance}} failed query ratio has been > 5% in last 5 minutes, current ratio: {{ $value }}"

  - alert: Slow Query Ratio Is Too High
    expr: ( round(sum by (job,instance) (delta(ke_queries_seconds_count{succeed="true"}[5m]))) - round(sum by (job,instance) (delta(ke_queries_seconds_count{succeed="true",le="15"}[5m]))) ) / round(sum by (instance) (delta(ke_queries_seconds_count{succeed="true"}[5m]))) > 0.05
    for: 1m
    labels:
      severity: signification
    annotations:
      summary: "{{$labels.job}} Instance {{$labels.instance}} slow query ratio is too high"
      description: "{{$labels.job}} Instance {{$labels.instance}} slow query(>15s) ratio has been > 5% in last 5 minutes, current ratio: {{ $value }}"

